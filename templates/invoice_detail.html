<!-- templates/invoice_detail.html -->
{% extends "base.html" %}
{% block title %}Накладная №{{ invoice.invoice_number }}{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1>Накладная №{{ invoice.invoice_number }}</h1>
        <p class="text-muted mb-0">Дата: {{ invoice.invoice_date.strftime('%d.%m.%Y') }} | ТМЦ: {{ tmc_count }} шт. | Стоимость: {{ "{:,.2f}".format(total_cost)|replace(',', ' ') }} ₽</p>
    </div>
    <div class="user-info">
        <a href="javascript:history.back()" class="btn btn-secondary btn-sm me-2">
            <i class="bi bi-arrow-left me-1"></i>Назад
        </a>
        <a href="{{ url_for('edit_invoice', invoice_id=invoice.id) }}" class="btn btn-warning btn-sm me-2">
            <i class="bi bi-pencil me-1"></i>Редактировать
        </a>
        <form method="POST" action="{{ url_for('delete_invoice', invoice_id=invoice.id) }}" style="display:inline;" onsubmit="return confirm('Вы уверены, что хотите удалить накладную? Это действие нельзя отменить.');">
            <button type="submit" class="btn btn-danger btn-sm me-2">
                <i class="bi bi-trash me-1"></i>Удалить
            </button>
        </form>
        {% if invoice.pdf_path %}
            <a href="{{ url_for('static', filename=invoice.pdf_path.split('/uploads/')[-1]) }}" target="_blank" class="btn btn-primary btn-sm">
                <i class="bi bi-file-pdf me-1"></i>PDF
            </a>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-header">
    <h5 class="mb-0">Основная информация</h5>
  </div>
  <div class="card-body">
    <p><strong>Тип:</strong> {{ invoice.type }}</p>
    <p><strong>Отдел:</strong> {{ invoice.department.name if invoice.department else '—' }}</p>

    <hr>
    <h6 class="fw-bold">Участники</h6>
    {% if invoice.type == 'Склад-МОЛ' %}
      <p><strong>Откуда (склад):</strong> {{ invoice.from_knt.name if invoice.from_knt else '—' }}</p>
      <p><strong>Кому (МОЛ):</strong> {{ invoice.to_user.login if invoice.to_user else '—' }}</p>
    {% elif invoice.type == 'МОЛ-Склад' %}
      <p><strong>От кого (МОЛ):</strong> {{ invoice.from_user.login if invoice.from_user else '—' }}</p>
      <p><strong>Куда (склад):</strong> {{ invoice.to_knt.name if invoice.to_knt else '—' }}</p>
    {% elif invoice.type == 'МОЛ-МОЛ' %}
      <p><strong>От кого:</strong> {{ invoice.from_user.login if invoice.from_user else '—' }}</p>
      <p><strong>Кому:</strong> {{ invoice.to_user.login if invoice.to_user else '—' }}</p>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm mt-3">
  <div class="card-header">
    <h5 class="mb-0">Оборудование в накладной</h5>
  </div>
  <div class="card-body">
{% if invoice.invoice_equipment %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Наименование</th>
          <th>Серийный №</th>
          <th>Инвентарный №</th>
          <th>Стоимость</th>  <!-- ← ДОБАВЛЕНА СТОИМОСТЬ -->
          <th>Комментарий</th>
        </tr>
      </thead>
      <tbody>
        {% for ie in invoice.invoice_equipment %}
          <tr style="cursor: pointer;" onclick="window.location='{{ url_for('info_tmc', tmc_id=ie.equipment.id) }}'">
            <td>{{ ie.equipment.nome.name if ie.equipment.nome else ie.equipment.buhname }}</td>
            <td>{{ ie.equipment.sernum or '—' }}</td>
            <td>{{ ie.equipment.invnum or '—' }}</td>
            <td>{{ "{:,.2f}".format(ie.equipment.cost) }} ₽</td>  <!-- ← ДОБАВЛЕНО ЗНАЧЕНИЕ -->
            <td>{{ ie.equipment.comment or '—' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="empty-state">
    <i class="bi bi-clipboard-data" style="font-size: 3rem;"></i>
    <h5>Нет оборудования</h5>
    <p class="mb-0">В накладной нет оборудования.</p>
  </div>
{% endif %}
  </div>
</div>

{% endblock %}