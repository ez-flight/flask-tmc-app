<!-- templates/add_tmc.html -->
{% extends "base.html" %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –¢–ú–¶{% endblock %}

{% block content %}
<h1>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –¢–ú–¶</h1>
<form method="POST" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="buhname" class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label>
        <input type="text" class="form-control" id="buhname" name="buhname" required>
    </div>
    <div class="mb-3">
        <label for="sernum" class="form-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
        <input type="text" class="form-control" id="sernum" name="sernum">
    </div>
    <div class="mb-3">
        <label for="invnum" class="form-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä</label>
        <input type="text" class="form-control" id="invnum" name="invnum">
    </div>
    
    <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ -->
    <div class="mb-3">
        <label for="date_start" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ *</label>
        <input type="date" class="form-control" id="date_start" name="date_start"
           value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
        <div class="form-text">–ù–∞ –µ—ë –æ—Å–Ω–æ–≤–µ –±—É–¥—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –≥–∞—Ä–∞–Ω—Ç–∏—è (+1 –≥–æ–¥) –∏ —Å—Ä–æ–∫ —Å–ª—É–∂–±—ã (+5 –ª–µ—Ç).</div>
    </div>
    <div class="mb-3">
        <label for="comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
    </div>
    <div class="mb-3">
        <label for="department_id" class="form-label">–û—Ç–¥–µ–ª *</label>
        <select class="form-select" id="department_id" name="department_id" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª --</option>
            {% for dept in departments %}
                <option value="{{ dept.id }}" {% if tmc and tmc.department_id == dept.id %}selected{% endif %}>
                     {{ dept.name }} ({{ dept.code }})
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="photo" class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
        <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, BMP, WEBP.</div>
    </div>
    <div class="mb-3">
        <label for="passport" class="form-label">–ü–∞—Å–ø–æ—Ä—Ç –¢–ú–¶ (PDF)</label>
        <input type="file" class="form-control" id="passport" name="passport" accept=".pdf">
        {% if tmc and tmc.passport_filename %}
           <div class="mt-2">
                –¢–µ–∫—É—â–∏–π –ø–∞—Å–ø–æ—Ä—Ç: 
                <a href="{{ url_for('static', filename='uploads/' + tmc.passport_filename) }}" target="_blank">üìÑ –û—Ç–∫—Ä—ã—Ç—å</a>
            </div>
        {% endif %}
    </div>
    
    <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
    <div class="mb-3">
        <label for="orgid" class="form-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è *</label>
        <select class="form-select" id="orgid" name="orgid" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é --</option>
            {% for org in organizations %}
                {% if org.active %}
                    <option value="{{ org.id }}">{{ org.name }}</option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <!-- –ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è -->
    <div class="mb-3">
        <label for="placesid" class="form-label">–ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è *</label>
        <select class="form-select" id="placesid" name="placesid" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ --</option>
            {% for place in places %}
                {% if place.active %}
                    <option value="{{ place.id }}">{{ place.name }}</option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
    <div class="mb-3">
        <label for="usersid" class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
        <select class="form-select" id="usersid" name="usersid" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
            {% for user in users %}
                {% if user.active %}
                    <option value="{{ user.id }}">{{ user.login }}</option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <!-- –ì—Ä—É–ø–ø–∞ –¢–ú–¶ -->
    {% if preselected_group %}
        <input type="hidden" name="groupid" value="{{ preselected_group.id }}">
    {% else %}
        <div class="mb-3">
            <label for="groupid" class="form-label">–ì—Ä—É–ø–ø–∞ –¢–ú–¶ *</label>
            <select class="form-select" id="groupid" name="groupid" required onchange="loadVendors()">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
                {% for group in groups %}
                    {% if group.active %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <!-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å -->
    {% if preselected_vendor %}
        <input type="hidden" name="vendorid" value="{{ preselected_vendor.id }}">
    {% else %}
        <div class="mb-3">
            <label for="vendorid" class="form-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å *</label>
            <select class="form-select" id="vendorid" name="vendorid" required onchange="loadNomenclatures()">
                <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
            </select>
        </div>
    {% endif %}

    <!-- –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞) -->
    {% if preselected_nome %}
        <input type="hidden" name="nomeid" value="{{ preselected_nome.id }}">
        <div class="mb-3">
            <label class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
            <div class="form-control" readonly>{{ preselected_nome.name }}</div>
        </div>
    {% else %}
        <div class="mb-3">
            <label for="nomeid" class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞) *</label>
            <div class="input-group">
                <select class="form-select" id="nomeid" name="nomeid" required>
                    <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è --</option>
                </select>
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addNomeModal">+</button>
            </div>
        </div>
    {% endif %}

    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å</button>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="addNomeModal" tabindex="-1" aria-labelledby="addNomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNomeModalLabel">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_nome_name" class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label>
                    <input type="text" class="form-control" id="new_nome_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ">
                    <div class="invalid-feedback">
                        –≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
                    </div>
                </div>
                <div class="alert alert-danger d-none" id="nome_error_alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="addNewNomenclature()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>



<script>
function loadVendors() {
    const groupId = document.getElementById('groupid').value;
    const vendorSelect = document.getElementById('vendorid');
    const nomeSelect = document.getElementById('nomeid');

    // –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ —Å–ø–∏—Å–∫–∏
    vendorSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    nomeSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è --</option>';

    if (!groupId) {
        vendorSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>';
        return;
    }

    fetch(`/get_vendors_by_group/${groupId}`)
        .then(response => response.json())
        .then(data => {
            vendorSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è --</option>';
            data.vendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor.id;
                option.textContent = vendor.name;
                vendorSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π:', error);
            vendorSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        });
}

function loadNomenclatures() {
    const groupId = document.getElementById('groupid').value;
    const vendorId = document.getElementById('vendorid').value;
    const nomeSelect = document.getElementById('nomeid');

    nomeSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';

    if (!groupId || !vendorId) {
        nomeSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è --</option>';
        return;
    }

    fetch(`/get_nomenclatures_by_group_and_vendor/${groupId}/${vendorId}`)
        .then(response => response.json())
        .then(data => {
            nomeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ --</option>';
            data.nomenclatures.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome.id;
                option.textContent = nome.name;
                nomeSelect.appendChild(option);
            });
            // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ
            if (data.nomenclatures.length === 0) {
                nomeSelect.innerHTML += '<option value="">-- –ù–µ—Ç –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ --</option>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π:', error);
            nomeSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        });
}

function addNewNomenclature() {
    const groupId = document.getElementById('groupid').value;
    const vendorId = document.getElementById('vendorid').value;
    const nomeName = document.getElementById('new_nome_name').value.trim();
    const errorAlert = document.getElementById('nome_error_alert');

    errorAlert.classList.add('d-none');
    errorAlert.textContent = '';

    if (!nomeName) {
        document.getElementById('new_nome_name').classList.add('is-invalid');
        return;
    } else {
        document.getElementById('new_nome_name').classList.remove('is-invalid');
    }

    fetch('/add_nomenclature', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `groupid=${groupId}&vendorid=${vendorId}&name=${encodeURIComponent(nomeName)}`
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('addNomeModal'));
            modal.hide();

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('new_nome_name').value = '';

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π
            loadNomenclatures();

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
            setTimeout(() => {
                const nomeSelect = document.getElementById('nomeid');
                for (let option of nomeSelect.options) {
                    if (option.value == data.id) {
                        option.selected = true;
                        break;
                    }
                }
            }, 500);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const container = document.querySelector('.container');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.prepend(alertDiv);
        }
    })
    .catch(error => {
        errorAlert.classList.remove('d-none');
        errorAlert.textContent = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    });
}
</script>
{% endblock %}