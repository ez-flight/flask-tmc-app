<!-- templates/all_tmc.html -->
{% extends "base.html" %}
{% block title %}Всё имущество{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1>Всё имущество</h1>
        <p class="text-muted mb-0">ТМЦ: {{ tmc_count }} шт. | Общая стоимость: {{ "{:,.2f}".format(total_cost) }} руб.</p>
    </div>
    <div class="user-info">
        <span class="text-muted">Вы вошли как: <strong>{{ user_login }}</strong></span>
        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>На главную
        </a>
    </div>
</div>

<!-- Фильтры -->
<form method="GET" class="row mb-3">
    <div class="col-md-4">
        <label for="userSelect" class="form-label">Фильтр по пользователю:</label>
        <select id="userSelect" name="user_id" class="form-select" onchange="this.form.submit()">
            <option value="">Всё имущество</option>
            {% for user in all_users %}
                <option value="{{ user.id }}" {% if filter_user_id == user.id %}selected{% endif %}>
                    {{ user.login }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label for="departmentSelect" class="form-label">Фильтр по отделу:</label>
        <select id="departmentSelect" name="department_id" class="form-select" onchange="this.form.submit()">
            <option value="">Все отделы</option>
            {% for dept in all_departments %}
                <option value="{{ dept.id }}" {% if filter_department_id == dept.id %}selected{% endif %}>
                    {{ dept.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label for="categorySelect" class="form-label">Фильтр по категории:</label>
        <select id="categorySelect" name="category_id" class="form-select" onchange="this.form.submit()">
            <option value="">Все категории</option>
            {% for cat in all_categories %}
                <option value="{{ cat.id }}" {% if filter_category_id == cat.id %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
    </div>
</form>

<!-- Информация для администраторов -->
{% if is_admin %}
<div class="alert alert-success d-flex align-items-center mb-3" role="alert">
    <i class="bi bi-shield-check me-2"></i>
    <span>Вы администратор. У вас полный доступ к системе.</span>
</div>
{% endif %}

<!-- Кнопки действий -->
<div class="mb-3">
    <a href="{{ url_for('add_nome') }}" class="btn btn-success me-2">
        <i class="bi bi-plus me-1"></i>Добавить группу ТМЦ
    </a>
    <a href="{{ url_for('invoice_list') }}" class="btn btn-info">
        <i class="bi bi-file-earmark-text me-1"></i>Накладные
    </a>
</div>

<!-- Таблица имущества -->
<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 80px;">Фото</th>
                        <th scope="col">Наименование</th>
                        <th scope="col" style="width: 100px;">Кол-во</th>
                        <th scope="col" style="width: 100px;">Статусы</th>
                    </tr>
                </thead>
                <tbody>
                    {% if grouped_tmc %}
                        {% for item in grouped_tmc %}
                        <tr onclick="window.location.href='{{ url_for('list_by_nome', nome_id=item.nomeid) }}'" 
                            style="cursor: pointer;" 
                            onmouseover="this.style.backgroundColor='#f8f9fa';" 
                            onmouseout="this.style.backgroundColor='';">
                            <td onclick="event.stopPropagation();">
                                {% if item.nome_photo %}
                                    <img src="{{ url_for('static', filename='uploads/' + item.nome_photo) }}" 
                                         alt="Фото {{ item.nome_name }}" 
                                         class="img-fluid rounded" 
                                         style="max-height: 60px; max-width: 60px; object-fit: cover;">
                                {% else %}
                                    <img src="{{ url_for('static', filename='uploads/noimage.jpg') }}" 
                                         alt="Фото {{ item.nome_name }}" 
                                         class="img-fluid rounded" 
                                         style="max-height: 60px; max-width: 60px; object-fit: cover;">
                                {% endif %}
                            </td>
                            <td>{{ item.nome_name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td onclick="event.stopPropagation();">
                                <div class="d-flex flex-column gap-1" style="align-items: flex-start;">
                                    {% if item.active_count and item.active_count > 0 %}
                                    <span class="badge bg-success">Э {{ item.active_count }}</span>
                                    {% endif %}
                                    {% if item.repair_count and item.repair_count > 0 %}
                                    <span class="badge bg-warning text-dark">Р {{ item.repair_count }}</span>
                                    {% endif %}
                                    {% if item.lost_count and item.lost_count > 0 %}
                                    <span class="badge bg-danger">П {{ item.lost_count }}</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="bi bi-clipboard-data" style="font-size: 3rem;"></i>
                                <h5>Нет данных</h5>
                                <p class="mb-0">Нет имущества, соответствующего выбранным фильтрам.</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}