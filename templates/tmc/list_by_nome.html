<!-- templates/list_by_nome.html -->
{% extends "base.html" %}
{% block title %}Детали: {{ nome.name }}{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1>Детали наименования: "{{ nome.name }}"</h1>
        <p class="text-muted mb-0">Всего: {{ tmc_list|length }} шт.</p>
    </div>
    <div class="user-info">
        <a href="javascript:history.back()" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Назад
        </a>
    </div>
</div>

<div class="mb-3">
    <a href="{{ url_for('add_tmc', nome_id=nome.id) }}" class="btn btn-success me-2">
        <i class="bi bi-plus me-1"></i>Добавить новый ТМЦ
    </a>
    {% if is_admin %}
        <a href="{{ url_for('bulk_edit_nome', nome_id=nome.id) }}" class="btn btn-primary me-2">
            <i class="bi bi-pencil-square me-1"></i>Групповое редактирование
        </a>
        {% if tmc_list %}
        <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#bulkCreateModal">
            <i class="bi bi-stack me-1"></i>Массовое создание ТМЦ
        </button>
        {% endif %}
    {% endif %}
    {% if is_admin or is_mol %}
        <a href="{{ url_for('edit_nome_group', nome_id=nome.id) }}" class="btn btn-info">
            <i class="bi bi-gear me-1"></i>Редактировать группу ТМЦ
        </a>
    {% endif %}
</div>

{% if nome.comment %}
    <div class="alert alert-primary mb-4">
        {{ nome.comment|replace('\n', '<br>')|safe }}
    </div>
{% endif %}

{% if tmc_list %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 80px;">Фото</th>
                        <th scope="col">Наименование</th>
                        <th scope="col">Серийный номер</th>
                        <th scope="col">Инвентарный номер</th>
                        <th scope="col">Комментарий</th>
                        <th scope="col">Дата постановки</th>
                        <th scope="col">Стоимость</th>
                        <th scope="col">Статус</th>
                    </tr>
                </thead>
        <tbody>
            {% for tmc in tmc_list %}
            <tr class="clickable-row" onclick="window.location='{{ url_for('info_tmc', tmc_id=tmc.id) }}'" style="cursor: pointer;">
                <td>
                    {% if tmc.photo %}
                        <img src="{{ url_for('static', filename='uploads/' + tmc.photo) }}" 
                             alt="Фото" 
                             class="img-fluid rounded" 
                             style="max-height: 60px; max-width: 60px; object-fit: cover;">
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/noimage.jpg') }}" 
                             alt="Нет фото" 
                             class="img-fluid rounded" 
                             style="max-height: 60px; max-width: 60px; object-fit: cover;">
                    {% endif %}
                </td>
                <td>
                    {% if tmc.buhname and tmc.buhname.strip() %}
                        <span title="{{ tmc.buhname|replace('"', '&quot;') }}" style="display: block; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ tmc.buhname }}
                        </span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>{{ tmc.sernum or '—' }}</td>
                <td>{{ tmc.invnum or '—' }}</td>
                <td>
                    {% if tmc.comment and tmc.comment.strip() %}
                        <span title="{{ tmc.comment|replace('"', '&quot;') }}" style="display: block; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ tmc.comment }}
                        </span>
                    {% else %}
                        <span class="text-muted" style="font-style: italic;">Нет комментария</span>
                    {% endif %}
                </td>
                <td>{{ tmc.datepost.strftime('%d.%m.%Y') if tmc.datepost else '—' }}</td>
                <td>{{ "{:,.2f}".format(tmc.cost) if tmc.cost else '0.00' }} руб.</td>
                <td onclick="event.stopPropagation();">
                    {% if tmc.active %}
                        {% if tmc.lost %}
                            <span class="badge bg-danger">Потерян</span>
                        {% elif tmc.repair %}
                            <span class="badge bg-warning text-dark">В ремонте</span>
                        {% elif tmc.mode %}
                            <span class="badge bg-info">На модернизации</span>
                        {% elif tmc.disposed %}
                            <span class="badge bg-secondary">Списано</span>
                        {% else %}
                            <span class="badge bg-success">В эксплуатации</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">Неактивно</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>
</div>
{% else %}
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <i class="bi bi-clipboard-data" style="font-size: 3rem;"></i>
                <h5>Нет данных</h5>
                <p class="mb-0">Нет ТМЦ с таким наименованием.</p>
            </div>
        </div>
    </div>
{% endif %}

<!-- Вывод шаблона комплекта (если есть) -->
{% if component_template %}
    <div class="card mt-4">
        <div class="card-header">
            Шаблон комплекта
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Порядок</th>
                            <th scope="col">Тип комплектующего</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in component_template %}
                        <tr>
                            <td>{{ comp.sort_order }}</td>
                            <td>{{ comp.component_nome.name }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endif %}

<!-- Модальное окно для массового создания ТМЦ -->
{% if is_admin and tmc_list %}
<div class="modal fade" id="bulkCreateModal" tabindex="-1" aria-labelledby="bulkCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkCreateModalLabel">
                    <i class="bi bi-stack me-2"></i>Массовое создание ТМЦ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('bulk_create_tmc', nome_id=nome.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="template_tmc" class="form-label">Выберите ТМЦ-шаблон <span class="text-danger">*</span></label>
                        <select class="form-select" id="template_tmc" name="template_tmc_id" required>
                            <option value="">-- Выберите ТМЦ --</option>
                            {% for tmc in tmc_list %}
                            <option value="{{ tmc.id }}">
                                {{ tmc.buhname }}
                                {% if tmc.sernum %} ({{ tmc.sernum }}){% endif %}
                                {% if tmc.invnum %} [{{ tmc.invnum }}]{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Выберите ТМЦ, данные которого будут использованы как шаблон</small>
                    </div>

                    <div class="mb-3">
                        <label for="quantity" class="form-label">Количество ТМЦ для создания <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" max="100" value="1" required>
                        <small class="form-text text-muted">Укажите количество ТМЦ, которые нужно создать (от 1 до 100)</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Выберите поля для копирования:</label>
                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="orgid" id="copy_orgid" checked>
                                        <label class="form-check-label" for="copy_orgid">Организация</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="placesid" id="copy_placesid" checked>
                                        <label class="form-check-label" for="copy_placesid">Место размещения</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="usersid" id="copy_usersid" checked>
                                        <label class="form-check-label" for="copy_usersid">Ответственный (МОЛ)</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="buhname" id="copy_buhname" checked>
                                        <label class="form-check-label" for="copy_buhname">Бухгалтерское наименование</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="cost" id="copy_cost" checked>
                                        <label class="form-check-label" for="copy_cost">Стоимость</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="currentcost" id="copy_currentcost" checked>
                                        <label class="form-check-label" for="copy_currentcost">Текущая стоимость</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="comment" id="copy_comment">
                                        <label class="form-check-label" for="copy_comment">Комментарий</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="photo" id="copy_photo">
                                        <label class="form-check-label" for="copy_photo">Фото</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="passport_filename" id="copy_passport">
                                        <label class="form-check-label" for="copy_passport">Паспорт</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="kntid" id="copy_kntid">
                                        <label class="form-check-label" for="copy_kntid">Поставщик</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="department_id" id="copy_department">
                                        <label class="form-check-label" for="copy_department">Отдел</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="datepost" id="copy_datepost">
                                        <label class="form-check-label" for="copy_datepost">Дата поступления</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="dtendgar" id="copy_dtendgar">
                                        <label class="form-check-label" for="copy_dtendgar">Дата окончания гарантии</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="dtendlife" id="copy_dtendlife">
                                        <label class="form-check-label" for="copy_dtendlife">Дата окончания срока службы</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="date_start" id="copy_date_start">
                                        <label class="form-check-label" for="copy_date_start">Дата начала эксплуатации</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="os" id="copy_os" checked>
                                        <label class="form-check-label" for="copy_os">Основное средство</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="ip" id="copy_ip">
                                        <label class="form-check-label" for="copy_ip">IP-адрес</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="invoice_file" id="copy_invoice">
                                        <label class="form-check-label" for="copy_invoice">Файл накладной</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="warehouse_rack" id="copy_warehouse_rack">
                                        <label class="form-check-label" for="copy_warehouse_rack">Стеллаж</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="warehouse_cell" id="copy_warehouse_cell">
                                        <label class="form-check-label" for="copy_warehouse_cell">Ячейка</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="unit_name" id="copy_unit_name">
                                        <label class="form-check-label" for="copy_unit_name">Единица измерения (наименование)</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="unit_code" id="copy_unit_code">
                                        <label class="form-check-label" for="copy_unit_code">Единица измерения (код)</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="profile" id="copy_profile">
                                        <label class="form-check-label" for="copy_profile">Профиль</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="size" id="copy_size">
                                        <label class="form-check-label" for="copy_size">Размер</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="copy_fields" value="stock_norm" id="copy_stock_norm">
                                        <label class="form-check-label" for="copy_stock_norm">Норма запаса</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="form-text text-muted mt-2 d-block">
                            <strong>Примечание:</strong> Серийный и инвентарный номера не копируются (останутся пустыми для новых ТМЦ)
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle me-1"></i>Создать ТМЦ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}