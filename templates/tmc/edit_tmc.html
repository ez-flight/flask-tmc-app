<!-- templates/edit_tmc.html -->
{% extends "base.html" %}

{% block title %}Редактировать ТМЦ{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1>Редактировать ТМЦ</h1>
        <p class="text-muted mb-0">
            <i class="bi bi-hash me-1"></i>ID: {{ tmc.id }}
            {% if tmc.nome %}
                <span class="ms-3"><i class="bi bi-tag me-1"></i>{{ tmc.nome.name }}</span>
            {% endif %}
        </p>
    </div>
    <div class="user-info">
        <a href="javascript:history.back()" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Назад
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            
            <!-- Секция: Основная информация -->
            <div class="mb-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    Основная информация
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="buhname" class="form-label">
                            <i class="bi bi-file-text me-1"></i>Наименование <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="buhname" 
                               name="buhname" 
                               value="{{ tmc.buhname }}" 
                               required
                               placeholder="Введите наименование ТМЦ">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="sernum" class="form-label">
                            <i class="bi bi-upc-scan me-1"></i>Серийный номер
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="sernum" 
                               name="sernum" 
                               value="{{ tmc.sernum }}"
                               placeholder="Введите серийный номер">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="invnum" class="form-label">
                            <i class="bi bi-123 me-1"></i>Инвентарный номер
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="invnum" 
                               name="invnum" 
                               value="{{ tmc.invnum }}"
                               placeholder="Введите инвентарный номер">
                    </div>
                    
                    <div class="col-md-12">
                        <label for="comment" class="form-label">
                            <i class="bi bi-chat-left-text me-1"></i>Комментарий
                        </label>
                        <textarea class="form-control" 
                                  id="comment" 
                                  name="comment" 
                                  rows="3"
                                  placeholder="Введите комментарий">{{ tmc.comment }}</textarea>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Секция: Классификация -->
            <div class="mb-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="bi bi-diagram-3 me-2 text-primary"></i>
                    Классификация
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="groupid" class="form-label">
                            <i class="bi bi-folder me-1"></i>Группа ТМЦ <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="groupid" 
                                name="groupid" 
                                required 
                                onchange="loadVendors()">
                            <option value="">-- Выберите группу --</option>
                            {% for group in groups %}
                                {% if group.active %}
                                    <option value="{{ group.id }}" {% if current_group and group.id == current_group.id %}selected{% endif %}>{{ group.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="vendorid" class="form-label">
                            <i class="bi bi-building me-1"></i>Производитель <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="vendorid" 
                                name="vendorid" 
                                required 
                                onchange="loadNomenclatures()">
                            <option value="">-- Сначала выберите группу --</option>
                            {% for vendor in vendors %}
                                <option value="{{ vendor.id }}" {% if current_vendor and vendor.id == current_vendor.id %}selected{% endif %}>{{ vendor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="nomeid" class="form-label">
                            <i class="bi bi-tag me-1"></i>Наименование (Номенклатура) <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <select class="form-select" 
                                    id="nomeid" 
                                    name="nomeid" 
                                    required>
                                <option value="">-- Сначала выберите производителя --</option>
                                {% for nome in nomenclatures %}
                                    <option value="{{ nome.id }}" {% if current_nome and nome.id == current_nome.id %}selected{% endif %}>{{ nome.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#addNomeModal"
                                    title="Добавить новое наименование">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Секция: Расположение и ответственные -->
            <div class="mb-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="bi bi-geo-alt me-2 text-primary"></i>
                    Расположение и ответственные
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="orgid" class="form-label">
                            <i class="bi bi-building me-1"></i>Организация <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="orgid" 
                                name="orgid" 
                                required>
                            <option value="">-- Выберите организацию --</option>
                            {% for org in organizations %}
                                {% if org.active %}
                                    <option value="{{ org.id }}" {% if org.id == tmc.orgid %}selected{% endif %}>{{ org.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="placesid" class="form-label">
                            <i class="bi bi-geo-alt me-1"></i>Место нахождения <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="placesid" 
                                name="placesid" 
                                required>
                            <option value="">-- Выберите место --</option>
                            {% for place in places %}
                                {% if place.active %}
                                    <option value="{{ place.id }}" {% if place.id == tmc.placesid %}selected{% endif %}>{{ place.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="usersid" class="form-label">
                            <i class="bi bi-person me-1"></i>Ответственный пользователь <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="usersid" 
                                name="usersid" 
                                required>
                            <option value="">-- Выберите пользователя --</option>
                            {% for user in users %}
                                {% if user.active %}
                                    <option value="{{ user.id }}" {% if user.id == tmc.usersid %}selected{% endif %}>{{ user.login }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="department_id" class="form-label">
                            <i class="bi bi-diagram-3 me-1"></i>Отдел <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="department_id" 
                                name="department_id" 
                                required>
                            <option value="">-- Выберите отдел --</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if tmc and tmc.department_id == dept.id %}selected{% endif %}>
                                    {{ dept.name }} ({{ dept.code }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Секция: Финансы и даты -->
            <div class="mb-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="bi bi-currency-exchange me-2 text-primary"></i>
                    Финансы и даты
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="cost" class="form-label">
                            <i class="bi bi-cash-stack me-1"></i>Первоначальная стоимость (₽)
                        </label>
                        <input type="number" 
                               step="0.01" 
                               class="form-control" 
                               id="cost" 
                               name="cost"
                               value="{{ '%.2f'|format(tmc.cost) if tmc.cost is not none else '0.00' }}"
                               placeholder="0.00">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="currentcost" class="form-label">
                            <i class="bi bi-cash me-1"></i>Текущая стоимость (₽)
                        </label>
                        <input type="number" 
                               step="0.01" 
                               class="form-control" 
                               id="currentcost" 
                               name="currentcost"
                               value="{{ '%.2f'|format(tmc.currentcost) if tmc.currentcost is not none else '0.00' }}"
                               placeholder="0.00">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="date_start" class="form-label">
                            <i class="bi bi-calendar-check me-1"></i>Дата начала эксплуатации <span class="text-danger">*</span>
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="date_start" 
                               name="date_start"
                               value="{{ tmc.datepost.strftime('%Y-%m-%d') if tmc.datepost else '' }}" 
                               required>
                        <small class="form-text text-muted">
                            На основе этой даты рассчитываются гарантия (+1 год) и срок службы (+5 лет)
                        </small>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Секция: Статус -->
            <div class="mb-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="bi bi-toggle-on me-2 text-primary"></i>
                    Статус ТМЦ
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="status" class="form-label">
                            <i class="bi bi-info-circle me-1"></i>Статус <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" 
                                id="status" 
                                name="status" 
                                required>
                            <option value="active" {% if not tmc.repair and not tmc.lost %}selected{% endif %}>В эксплуатации</option>
                            <option value="repair" {% if tmc.repair and not tmc.lost %}selected{% endif %}>В ремонте</option>
                            <option value="lost" {% if tmc.lost %}selected{% endif %}>Потерян</option>
                        </select>
                        <small class="form-text text-muted">Выберите текущий статус ТМЦ</small>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Секция: Документы и фото -->
            <div class="mb-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="bi bi-file-earmark me-2 text-primary"></i>
                    Документы и фото
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="passport" class="form-label">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Паспорт ТМЦ (PDF)
                        </label>
                        <input type="file" 
                               class="form-control" 
                               id="passport" 
                               name="passport" 
                               accept=".pdf">
                        {% if tmc.passport_filename %}
                            <div class="mt-2">
                                <small class="text-muted d-block mb-2">Текущий паспорт:</small>
                                <a href="{{ url_for('static', filename='passports/' + tmc.passport_filename) }}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-pdf me-1"></i>Открыть паспорт
                                </a>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="delete_passport" 
                                           name="delete_passport" 
                                           value="1">
                                    <label class="form-check-label" for="delete_passport">
                                        Удалить паспорт
                                    </label>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="photo" class="form-label">
                            <i class="bi bi-image me-1"></i>Фотография
                        </label>
                        <input type="file" 
                               class="form-control" 
                               id="photo" 
                               name="photo" 
                               accept="image/*">
                        <small class="form-text text-muted">
                            Поддерживаются форматы: JPG, PNG, GIF, BMP, WEBP
                        </small>
                        {% if tmc.photo and tmc.photo.strip() %}
                            <div class="mt-2">
                                <small class="text-muted d-block mb-2">Текущее фото ТМЦ:</small>
                                <img src="{{ url_for('static', filename='uploads/' + tmc.photo) }}" 
                                     alt="Текущее фото" 
                                     class="img-thumbnail rounded"
                                     style="max-width: 150px; max-height: 150px; object-fit: cover;">
                                <small class="form-text d-block mt-1">Загрузите новое изображение, чтобы заменить</small>
                            </div>
                        {% elif tmc.nome and tmc.nome.photo and tmc.nome.photo.strip() %}
                            <div class="mt-2">
                                <small class="text-muted d-block mb-2">Текущее фото группы:</small>
                                <img src="{{ url_for('static', filename='uploads/' + tmc.nome.photo) }}" 
                                     alt="Фото группы" 
                                     class="img-thumbnail rounded"
                                     style="max-width: 150px; max-height: 150px; object-fit: cover;">
                                <small class="form-text d-block mt-1">У ТМЦ нет своего фото, отображается фото группы</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Кнопки действий -->
            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                <a href="javascript:history.back()" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i>Отмена
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>Сохранить изменения
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для добавления нового наименования -->
<div class="modal fade" id="addNomeModal" tabindex="-1" aria-labelledby="addNomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNomeModalLabel">Добавить новое наименование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_nome_name" class="form-label">Наименование *</label>
                    <input type="text" class="form-control" id="new_nome_name" placeholder="Введите наименование">
                    <div class="invalid-feedback">
                        Это поле обязательно.
                    </div>
                </div>
                <div class="alert alert-danger d-none" id="nome_error_alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addNewNomenclature()">Добавить</button>
            </div>
        </div>
    </div>
</div>


<script>
function loadVendors() {
    const groupId = document.getElementById('groupid').value;
    const vendorSelect = document.getElementById('vendorid');
    const nomeSelect = document.getElementById('nomeid');

    // Очищаем зависимые списки
    vendorSelect.innerHTML = '<option value="">Загрузка...</option>';
    nomeSelect.innerHTML = '<option value="">-- Сначала выберите производителя --</option>';

    if (!groupId) {
        vendorSelect.innerHTML = '<option value="">-- Сначала выберите группу --</option>';
        return;
    }

    fetch(`/get_vendors_by_group/${groupId}`)
        .then(response => response.json())
        .then(data => {
            vendorSelect.innerHTML = '<option value="">-- Выберите производителя --</option>';
            data.vendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor.id;
                option.textContent = vendor.name;
                vendorSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки производителей:', error);
            vendorSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
        });
}

function loadNomenclatures() {
    const groupId = document.getElementById('groupid').value;
    const vendorId = document.getElementById('vendorid').value;
    const nomeSelect = document.getElementById('nomeid');

    nomeSelect.innerHTML = '<option value="">Загрузка...</option>';

    if (!groupId || !vendorId) {
        nomeSelect.innerHTML = '<option value="">-- Сначала выберите производителя --</option>';
        return;
    }

    fetch(`/get_nomenclatures_by_group_and_vendor/${groupId}/${vendorId}`)
        .then(response => response.json())
        .then(data => {
            nomeSelect.innerHTML = '<option value="">-- Выберите наименование --</option>';
            data.nomenclatures.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome.id;
                option.textContent = nome.name;
                nomeSelect.appendChild(option);
            });
            // Если список пуст, предлагаем добавить новое
            if (data.nomenclatures.length === 0) {
                nomeSelect.innerHTML += '<option value="">-- Нет наименований. Добавьте новое --</option>';
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки наименований:', error);
            nomeSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
        });
}

function addNewNomenclature() {
    const groupId = document.getElementById('groupid').value;
    const vendorId = document.getElementById('vendorid').value;
    const nomeName = document.getElementById('new_nome_name').value.trim();
    const errorAlert = document.getElementById('nome_error_alert');

    errorAlert.classList.add('d-none');
    errorAlert.textContent = '';

    if (!nomeName) {
        document.getElementById('new_nome_name').classList.add('is-invalid');
        return;
    } else {
        document.getElementById('new_nome_name').classList.remove('is-invalid');
    }

    fetch('/add_nomenclature', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `groupid=${groupId}&vendorid=${vendorId}&name=${encodeURIComponent(nomeName)}`
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || 'Ошибка сервера'); });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addNomeModal'));
            modal.hide();

            // Очищаем поле ввода
            document.getElementById('new_nome_name').value = '';

            // Перезагружаем список наименований
            loadNomenclatures();

            // Автоматически выбираем только что добавленное наименование
            setTimeout(() => {
                const nomeSelect = document.getElementById('nomeid');
                for (let option of nomeSelect.options) {
                    if (option.value == data.id) {
                        option.selected = true;
                        break;
                    }
                }
            }, 500);

            // Показываем уведомление
            const container = document.querySelector('.container');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                Наименование успешно добавлено!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.prepend(alertDiv);
        }
    })
    .catch(error => {
        errorAlert.classList.remove('d-none');
        errorAlert.textContent = error.message || 'Неизвестная ошибка';
    });
}
</script>
{% endblock %}