<!-- templates/index.html -->
{% extends "base.html" %}
{% block title %}Личный кабинет{% endblock %}
{% block content %}

<div class="row">
<!-- Левая колонка: профиль и меню -->
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Пользователь</h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ user_photo }}" class="img-fluid rounded-circle mb-3" alt="Фото">
                <h6>{{ user_login }}</h6>
                {% if is_admin %}
                    <span class="badge bg-success">Администратор</span>
                {% else %}
                    <span class="badge bg-info">МОЛ</span>
                    <small class="text-muted">ТМЦ: {{ tmc_count }} шт.</small></br>
                    <small class="text-muted">Общая стоимость: {{ "{:,.2f}".format(total_cost) }} руб.</small>
                {% endif %}
                <br><br>

                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm w-100">Выйти</a>
            </div>
        </div>

        <div class="card shadow-sm mt-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">Личное меню</h5>
            </div>
            <div class="list-group list-group-flush">
                {% if is_admin %}
                    <a href="{{ url_for('all_tmc') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-bar-chart me-2"></i>Просмотр всего имущества
                    </a>
                    <a href="{{ url_for('invoice_list') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-file-earmark-text me-2"></i>Накладные
                    </a>
                    <a href="{{ url_for('manage_categories') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-pencil-square me-2"></i>Управление категориями
                    </a>
                    <a href="{{ url_for('all_components') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-puzzle me-2"></i>Комплектующие
                    </a>
                    <a href="{{ url_for('manage_users') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-people me-2"></i>Управление пользователями
                    </a>
                {% else %}
                    {% if tmc_count > 0 %}
                        <a href="{{ url_for('my_tmc') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-folder me-2"></i>Моё имущество
                        </a>
                        <a href="{{ url_for('invoice_list') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-file-earmark-text me-2"></i>Накладные
                        </a>
                        <a href="{{ url_for('my_temp_tmc') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-file-earmark-text me-2"></i>Полученные ТМЦ
                        </a>
                    {% else %}
                        <a href="{{ url_for('my_temp_tmc') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-file-earmark-text me-2"></i>Полученные ТМЦ
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Правая колонка: контент -->
    <div class="col-md-9">

        <!-- Приветствие и статистика -->
        <div class="d-flex align-items-center mb-4">
            <div>
                <h2>Добро пожаловать, {{ user_login }}!</h2>
               
            </div>
        </div>

        {% if is_admin %}
            <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-check me-2" viewBox="0 0 16 16">
                    <path d="M5.338 1.59a6.7 6.7 0 0 1 .683-1.02A12 12 0 0 1 7.875 0q.294.001.59.036a12.04 12.04 0 0 1 2.426.764c.59.272 1.154.59 1.683 1.02l.002.001.27.307c.004.004.008.009.013.015a6.85 6.85 0 0 1 1.11 1.505c.583 1.35 1.173 3.162 1.173 5.06 0 1.898-.59 3.71-1.173 5.06a6.7 6.7 0 0 1-1.11 1.505c-.004.005-.008.01-.013.015l-.27.307a.99.99 0 0 1-.013.015c-.005.005-.009.009-.014.013l-.08.068-.25.205c-.075.06-.16.09-.26.09z"/>
                    <path d="M12.64 10.051a.717.717 0 0 1-.909-.53 1.5 1.5 0 0 0-2.45-.817.72.72 0 0 1-1.165-.891 3 3 0 0 1 4.602-1.222.717.717 0 0 1 .08 1.208c-1.07.757-1.837 2.254-1.837 4.284 0 1.483.478 2.758 1.18 3.67a.72.72 0 0 1-.598 1.18 4.244 4.244 0 0 1-2.276-.692 6.9 6.9 0 0 1-2.81-2.586.72.72 0 0 1 .788-1.07c.354.374.827.672 1.403.844 1.25.36 2.5-.154 2.5-1.48 0-1.623-1.513-2.717-2.5-2.717a1.5 1.5 0 0 0-1.5 1.5c0 .278.044.55.128.803a.717.717 0 0 1-1.27.85l-.02-.02a1.5 1.5 0 0 0-1.08-1.287c-.897-.23-1.82-.448-2.75-.653a.72.72 0 0 1 .321-1.397c.94.207 1.875.427 2.824.665a2.5 2.5 0 0 1 2.25-1.875c1.56 0 2.91.97 3.39 2.354a.72.72 0 0 1-.44.926 1.5 1.5 0 0 0 .009 2.04c-.586.643-1.367.988-2.179.988-1.573 0-2.875-1.165-2.875-2.5 0-.79.35-1.513.904-2.037a.72.72 0 0 1 1.057.054c.312.35.735.56 1.215.56.82 0 1.558-.53 1.852-1.315a.717.717 0 0 1 1.32.34z"/>
                </svg>
                <span>Вы администратор. У вас полный доступ к системе.</span>
            </div>
        {% endif %}
        <!-- Статистика по системе (только для администратора) -->
        {% if is_admin %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Статистика системы</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-3 col-6 mb-3">
                        <h6 class="mb-1 text-muted">Всего ТМЦ</h6>
                        <p class="display-6 mb-0 text-primary">{{ tmc_count }}</p>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <h6 class="mb-1 text-muted">Общая стоимость</h6>
                        <p class="display-6 display-md-4 display-lg-6 mb-0 text-nowrap text-success">
                            {{ "{:,.0f}".format(total_cost) }} руб.
                        </p>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <h6 class="mb-1 text-muted">Активных пользователей</h6>
                        <p class="display-6 mb-0 text-info">{{ active_users }}</p>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <h6 class="mb-1 text-muted">Комплектующих</h6>
                        <p class="display-6 mb-0 text-warning">{{ stats_data.get('components_count', 0) }}</p>
                    </div>
                </div>
                
                <!-- Графики и диаграммы -->
                <div class="row">
                    <!-- Круговая диаграмма: Распределение по категориям (количество) -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">ТМЦ по категориям (количество)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Круговая диаграмма: Распределение по категориям (стоимость) -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">ТМЦ по категориям (стоимость)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryCostChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Столбчатая диаграмма: Топ отделов -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Топ-10 отделов по количеству ТМЦ</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="departmentChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Столбчатая диаграмма: Топ пользователей -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Топ-10 пользователей по количеству ТМЦ</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="userChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Линейный график: Динамика добавления ТМЦ -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Динамика добавления ТМЦ (последние 12 месяцев)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="monthlyChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Круговая диаграмма: Статусы ТМЦ -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Статусы ТМЦ</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        // Данные для графиков
        const statsData = {{ stats_data | tojson }};
        
        // Цвета для графиков
        const colors = [
            '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
            '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
        ];
        
        // Функция для генерации цветов
        function generateColors(count) {
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }
        
        // График: Распределение по категориям (количество)
        if (statsData.category_labels && statsData.category_labels.length > 0) {
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: statsData.category_labels,
                    datasets: [{
                        data: statsData.category_counts,
                        backgroundColor: generateColors(statsData.category_labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' шт.';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('categoryChart').parentElement.innerHTML = '<p class="text-muted text-center py-4">Нет данных</p>';
        }
        
        // График: Распределение по категориям (стоимость)
        if (statsData.category_cost_labels && statsData.category_cost_labels.length > 0) {
            const categoryCostCtx = document.getElementById('categoryCostChart').getContext('2d');
            new Chart(categoryCostCtx, {
                type: 'doughnut',
                data: {
                    labels: statsData.category_cost_labels,
                    datasets: [{
                        data: statsData.category_costs,
                        backgroundColor: generateColors(statsData.category_cost_labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toLocaleString('ru-RU') + ' руб.';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('categoryCostChart').parentElement.innerHTML = '<p class="text-muted text-center py-4">Нет данных</p>';
        }
        
        // График: Топ отделов
        if (statsData.department_labels && statsData.department_labels.length > 0) {
            const departmentCtx = document.getElementById('departmentChart').getContext('2d');
            new Chart(departmentCtx, {
                type: 'bar',
                data: {
                    labels: statsData.department_labels,
                    datasets: [{
                        label: 'Количество ТМЦ',
                        data: statsData.department_counts,
                        backgroundColor: '#0d6efd',
                        borderColor: '#0a58ca',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Количество: ' + context.parsed.y + ' шт.';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('departmentChart').parentElement.innerHTML = '<p class="text-muted text-center py-4">Нет данных</p>';
        }
        
        // График: Топ пользователей
        if (statsData.user_labels && statsData.user_labels.length > 0) {
            const userCtx = document.getElementById('userChart').getContext('2d');
            new Chart(userCtx, {
                type: 'bar',
                data: {
                    labels: statsData.user_labels,
                    datasets: [{
                        label: 'Количество ТМЦ',
                        data: statsData.user_counts,
                        backgroundColor: '#198754',
                        borderColor: '#146c43',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Количество: ' + context.parsed.x + ' шт.';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('userChart').parentElement.innerHTML = '<p class="text-muted text-center py-4">Нет данных</p>';
        }
        
        // График: Динамика добавления ТМЦ
        if (statsData.monthly_labels && statsData.monthly_labels.length > 0) {
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: statsData.monthly_labels,
                    datasets: [{
                        label: 'Количество добавленных ТМЦ',
                        data: statsData.monthly_counts,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Добавлено: ' + context.parsed.y + ' шт.';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('monthlyChart').parentElement.innerHTML = '<p class="text-muted text-center py-4">Нет данных</p>';
        }
        
        // График: Статусы ТМЦ
        if (statsData.status_labels && statsData.status_labels.length > 0) {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: statsData.status_labels,
                    datasets: [{
                        data: statsData.status_counts,
                        backgroundColor: ['#198754', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' шт.';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('statusChart').parentElement.innerHTML = '<p class="text-muted text-center py-4">Нет данных</p>';
        }
        </script>
        {% endif %}
         <!-- Блок новостей -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Новости / объявления</h5>
            </div>
            <div class="card-body">
                {% if news_list %}
                    {% for news in news_list %}
                        <div class="border rounded p-3 mb-3">
                            <small class="text-muted">{{ news.dt.strftime('%d.%m.%Y') }}</small>
                            <h6 class="mt-2">{{ news.title }}</h6>
                            <div class="mt-2">{{ news.body|replace('\n', '<br>')|safe }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        Нет новых объявлений.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Последние перемещения ТМЦ -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Последние перемещения ТМЦ</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th scope="col">Дата</th>
                                <th scope="col">Помещение</th>
                                <th scope="col">Откуда</th>
                                <th scope="col">Помещение</th>
                                <th scope="col">Куда</th>
                                <th scope="col">ТМЦ</th>
                                <th scope="col">Комментарий</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if moves %}
                                {% for move in moves %}
                                    <tr>
                                        <td>{{ move.dt.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>{{ move.placesidfrom }}</td>
                                        <td>{{ move.placesidto }}</td>
                                        <td>{{ move.placesidfrom }}</td>
                                        <td>{{ move.placesidto }}</td>
                                        <td>{{ move.eqid }}</td>
                                        <td>{{ move.comment }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">Нет перемещений.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}