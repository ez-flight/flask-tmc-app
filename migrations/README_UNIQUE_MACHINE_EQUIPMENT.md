# Миграция: Связь один к одному между Machine и Equipment

## Описание

Эта миграция изменяет связь между таблицами `machines` и `equipment` с "один ко многим" на "один к одному".

**До миграции:**
- Одно ТМЦ могло быть привязано к нескольким машинам
- Одна машина могла быть привязана только к одному ТМЦ

**После миграции:**
- Одно ТМЦ может быть привязано только к одной машине
- Одна машина может быть привязана только к одному ТМЦ

## Важно перед применением

⚠️ **Перед применением миграции убедитесь, что в базе данных нет дубликатов!**

Если в таблице `machines` есть несколько записей с одинаковым `equipment_id` (кроме NULL), миграция не пройдет. Нужно сначала исправить такие случаи вручную.

### Проверка на дубликаты

Выполните SQL-запрос для проверки:

```sql
SELECT equipment_id, COUNT(*) as count
FROM machines
WHERE equipment_id IS NOT NULL
GROUP BY equipment_id
HAVING count > 1;
```

Если запрос вернул результаты, нужно:
1. Определить, какая машина должна остаться привязанной к каждому ТМЦ
2. Отвязать остальные машины (установить `equipment_id = NULL`)

## Применение миграции

### Вариант 1: Использование Python-скрипта (рекомендуется)

```bash
cd /home/flask_tmc_app
source venv/bin/activate
python3 migrations/run_add_unique_constraint_machine_equipment.py
```

### Вариант 2: Прямое выполнение SQL

```bash
mysql -u root -p webuseorg3 < migrations/add_unique_constraint_machine_equipment.sql
```

## Что делает миграция

1. Добавляет уникальный индекс на поле `equipment_id` в таблице `machines`
2. Гарантирует, что каждое ТМЦ может быть привязано только к одной машине

## Изменения в коде

### models.py
- Поле `equipment_id` теперь имеет параметр `unique=True`
- Связь `equipment` изменена на `uselist=False` (один к одному)
- Обратная связь в `Equipment` теперь называется `machine` (единственное число) вместо `machines`

### app.py
- Добавлены проверки при ручной привязке машины к ТМЦ
- Добавлены проверки при автоматической привязке
- При попытке привязать ТМЦ, которое уже привязано к другой машине, выводится предупреждение

## Откат миграции (если необходимо)

Если нужно откатить изменения:

```sql
ALTER TABLE `machines` DROP INDEX `idx_equipment_id_unique`;
```

⚠️ **Внимание:** После отката нужно также изменить код в `models.py`, убрав `unique=True` и изменив `uselist=False` обратно на `uselist=True`.

