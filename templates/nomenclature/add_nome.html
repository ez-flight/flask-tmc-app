<!-- templates/add_nome.html -->
{% extends "base.html" %}
{% block title %}Добавить новую группу ТМЦ{% endblock %}
{% block content %}
<div class="page-header">
    <h1>Добавить новую группу ТМЦ</h1>
    <div class="user-info">
        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Назад
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="name" class="form-label">Наименование *</label>
        <input type="text" class="form-control" id="name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="groupid" class="form-label">Группа *</label>
        <div class="input-group">
            <select class="form-select" id="groupid" name="groupid" required>
                <option value="">-- Выберите группу --</option>
                {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addGroupModal" title="Добавить новую группу">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </div>
    <div class="mb-3">
        <label for="vendorid" class="form-label">Производитель *</label>
        <div class="input-group">
            <select class="form-select" id="vendorid" name="vendorid" required>
                <option value="">-- Выберите производителя --</option>
                {% for vendor in vendors %}
                    <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addVendorModal" title="Добавить нового производителя">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </div> 
    <!-- Поле количества ТМЦ -->
    <div class="mb-3">
        <label for="quantity" class="form-label">Количество ТМЦ *</label>
        <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
    </div>
    <!-- Дата постановки на учет -->
    <div class="mb-3">
        <label for="date_start" class="form-label">Дата постановки на учет *</label>
        <input type="date" class="form-control" id="date_start" name="date_start" required>
    </div>
    <div class="mb-3">
        <label for="placesid" class="form-label">Место установки *</label>
        <select class="form-select" id="placesid" name="placesid" required>
            <option value="">-- Выберите место --</option>
            {% for place in places %}
                <option value="{{ place.id }}">{{ place.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="department_id" class="form-label">Отдел</label>
        <select class="form-select" id="department_id" name="department_id">
            <option value="">-- Выберите отдел (необязательно) --</option>
            {% for department in departments %}
                <option value="{{ department.id }}">{{ department.name }} ({{ department.code }})</option>
            {% endfor %}
        </select>
        <small class="form-text text-muted">Отдел, к которому относится ТМЦ</small>
    </div>
    <!-- Стоимость -->
    <div class="mb-3">
        <label for="cost" class="form-label">Стоимость (необязательно)</label>
        <input type="number" step="0.01" class="form-control" id="cost" name="cost" min="0">
    </div>

    <!-- Комментарий к наименованию -->
    <div class="mb-3">
        <label for="comment" class="form-label">Комментарий к наименованию (необязательно)</label>
        <textarea class="form-control" id="comment" name="comment" rows="2"></textarea>
    </div>

    <!-- Выбор МОЛа -->
    <div class="mb-3">
        <label for="usersid" class="form-label">МОЛ (материально-ответственное лицо) *</label>
        <select class="form-select" id="usersid" name="usersid" required>
            <option value="">-- Выберите МОЛа --</option>
            {% for user in users %}
                <option value="{{ user.id }}">{{ user.login }}</option>
            {% endfor %}
        </select>
    </div>
    <!-- Серийный и инвентарный номера -->
    <div class="mb-3">
        <label for="sernum" class="form-label">Серийный номер (только для первого ТМЦ, если количество >1)</label>
        <input type="text" class="form-control" id="sernum" name="sernum">
    </div>
    <div class="mb-3">
        <label for="invnum" class="form-label">Инвентарный номер (только для первого ТМЦ, если количество >1)</label>
        <input type="text" class="form-control" id="invnum" name="invnum">
    </div>
    <!-- Фото группы -->
    <div class="mb-3">
        <label for="photo" class="form-label">Фото группы (применится ко всем ТМЦ) *</label>
        <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
    </div>
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-1"></i>Добавить новую группу ТМЦ
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i>Отмена
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для добавления новой группы -->
<div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGroupModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Добавить новую группу
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addGroupForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_group_name" class="form-label">Название группы <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="new_group_name" name="name" required maxlength="255" placeholder="Введите название группы">
                    </div>
                    <div class="mb-3">
                        <label for="new_group_comment" class="form-label">Комментарий (необязательно)</label>
                        <textarea class="form-control" id="new_group_comment" name="comment" rows="2" placeholder="Описание группы"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i>Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления нового производителя -->
<div class="modal fade" id="addVendorModal" tabindex="-1" aria-labelledby="addVendorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVendorModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Добавить нового производителя
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addVendorForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_vendor_name" class="form-label">Название производителя <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="new_vendor_name" name="name" required maxlength="155" placeholder="Введите название производителя">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i>Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Обработка добавления новой группы
document.getElementById('addGroupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const name = formData.get('name').trim();
    const comment = formData.get('comment')?.trim() || '';
    
    if (!name) {
        alert('Название группы обязательно');
        return;
    }
    
    fetch('{{ url_for("add_group_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            name: name,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Добавляем новую группу в селект
            const select = document.getElementById('groupid');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = data.name;
            option.selected = true;
            select.appendChild(option);
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addGroupModal'));
            modal.hide();
            
            // Очищаем форму
            document.getElementById('addGroupForm').reset();
        } else {
            alert('Ошибка: ' + (data.message || 'Не удалось добавить группу'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при добавлении группы');
    });
});

// Обработка добавления нового производителя
document.getElementById('addVendorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const name = formData.get('name').trim();
    
    if (!name) {
        alert('Название производителя обязательно');
        return;
    }
    
    fetch('{{ url_for("add_vendor_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Добавляем нового производителя в селект
            const select = document.getElementById('vendorid');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = data.name;
            option.selected = true;
            select.appendChild(option);
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addVendorModal'));
            modal.hide();
            
            // Очищаем форму
            document.getElementById('addVendorForm').reset();
        } else {
            alert('Ошибка: ' + (data.message || 'Не удалось добавить производителя'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при добавлении производителя');
    });
});
</script>

{% endblock %}